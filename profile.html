<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Profil</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.8/axios.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; background-color: #000; font-family: sans-serif; }
    header {
      width: 100%; background-color: #111; padding: 16px; color: white;
      font-size: 18px; font-weight: bold; display: flex; align-items: center;
    }
    header::before {
      content: ''; display: inline-block; width: 24px; height: 24px; margin-right: 7px;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'><path d='M10 19l-7-7 7-7v4h11v6H10v4z'/></svg>");
      background-size: contain; background-repeat: no-repeat; cursor: pointer;
    }
    .container { display: flex; flex-direction: column; align-items: center; padding: 32px 20px; }
    #profile-pic-container {
      position: relative; width: 130px; height: 130px; margin-bottom: 30px;
    }
    #profile-pic {
      width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #FFD700;
    }
    #camera-icon {
      position: absolute; bottom: -2px; right: -2px; background-color: #FFD700;
      border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center;
      justify-content: center; border: 2px solid black; cursor: pointer;
    }
    #camera-icon svg {
      width: 30px; height: 30px; margin-left: -25px; fill: black;
    }
    #upload { display: none; }
    .form-group { width: 100%; max-width: 320px; margin-bottom: 20px; }
    label {
      display: flex; align-items: center; font-size: 14px; font-weight: bold; color: white; margin-bottom: 5px;
    }
    label::before {
      content: ''; display: inline-block; width: 18px; height: 18px; margin-right: 8px; background-size: contain;
    }
    label[for="namaInput"]::before {
      background-image: url('data:image/svg+xml;utf8,<svg fill="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8V22h19.2v-2.8c0-3.2-6.4-4.8-9.6-4.8z"/></svg>');
    }
    label[for="statusInput"]::before {
      background-image: url('data:image/svg+xml;utf8,<svg fill="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.5 2 2 6 2 11c0 4.4 3.5 8 8 8h1v3l5-4h4c1.7 0 3-1.3 3-3v-1C23 6 17.5 2 12 2z"/></svg>');
    }
    label[for="nomorInput"]::before {
      background-image: url('data:image/svg+xml;utf8,<svg fill="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6.6 10.8c1.6 3.1 4.2 5.6 7.3 7.3l2.4-2.4c.3-.3.8-.4 1.2-.2 1.3.5 2.7.8 4.1.8.7 0 1.3.6 1.3 1.3V21c0 .7-.6 1.3-1.3 1.3C9.3 22.3 1.7 14.7 1.7 4.3 1.7 3.6 2.3 3 3 3h3.4c.7 0 1.3.6 1.3 1.3 0 1.4.3 2.8.8 4.1.2.4.1.9-.2 1.2l-1.7 1.2z"/></svg>');
    }
    .form-input {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: none;
      background-color: #222; color: white; font-size: 15px;
    }
    .form-input::placeholder { color: #aaa; }
  </style>
</head>
<body>
  <div class="header" onclick="simpanPengaturan()"><header>Profil</header></div>
  <div class="container">
    
    <div id="profile-pic-container">
      <img id="profile-pic" src="data:image/svg+xml;utf8,<svg fill='%23ccc' viewBox='1 0 22 22' xmlns='http://www.w3.org/2000/svg'><path d='M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8V22h19.2v-2.8c0-3.2-6.4-4.8-9.6-4.8z'/></svg>" />
      <label for="upload" id="camera-icon">
        <svg viewBox="0 0 24 24"><path d="M20 5h-3.17l-1.83-2H9L7.17 5H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V7a2 2 0 00-2-2zm-8 13a5 5 0 110-10 5 5 0 010 10zm0-8.5a3.5 3.5 0 100 7 3.5 3.5 0 000-7z"/></svg>
      </label>
      <input type="file" id="upload" accept="image/*">
    </div>
    <div id="popup-menu" style="display:none; position:fixed; bottom:0; left:0; right:0; background:#222; color:white; border-top:1px solid #555; z-index:9999; padding:10px 0; text-align:center;">
  <div style="padding:10px; border-bottom:1px solid #444; cursor:pointer;" onclick="ambilFoto()">Ambil Foto</div>
  
  <div style="padding:10px; border-bottom:1px solid #444; cursor:pointer;" onclick="pilihDariGaleri()">Pilih dari Galeri</div
  >
  <div style="padding:10px; cursor:pointer;" onclick="pakaiAvatar()">Avatar Default</div>
  
  <div style="padding:10px; color:#aaa; font-size:13px;" onclick="tutupPopup()">Batal</div>
</div>
    
    <div class="form-group">
      <label for="namaInput">Nama:</label>
      <input class="form-input" id="namaInput" type="text" placeholder="Masukkan nama">
    </div>
    <div class="form-group">
      <label for="statusInput">Tentang</label>
      <input class="form-input" id="tentangInput" type="text" placeholder="your code" readonly>
    </div>
    <div class="form-group">
      <label for="nomorInput">Telepon</label>
      <input class="form-input" type="text" id="nomorInput" placeholder="+62 812-3456-7890">
    </div>
  </div>




  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAWs21ruR4Tbu8Xspr1_0t9G4-bXKIrSHU",
      authDomain: "projectbesar-4f8ce.firebaseapp.com",
      projectId: "projectbesar-4f8ce",
      storageBucket: "projectbesar-4f8ce.appspot.com",
      messagingSenderId: "780129512462",
      appId: "1:780129512462:web:5c7ea2c54aa777e127a05f",
      measurementId: "G-JL3VVKSD4F",
      databaseURL: "https://projectbesar-4f8ce-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const upload = document.getElementById('upload');
    const profilePic = document.getElementById('profile-pic');
    const userId = getAtauBuatUserId();
    const userRef = db.ref('users/' + userId);

    upload.addEventListener('change', function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    profilePic.src = e.target.result;
  };
  reader.readAsDataURL(file);

  // Upload ke Cloudinary
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', 'BangKres'); // Ganti ini

  axios.post('https://api.cloudinary.com/v1_1/dhlqem94y/image/upload', formData)
  .then(res => {
    const imageUrl = res.data.secure_url + '?v=' + new Date().getTime();
    profilePic.src = imageUrl;
    userRef.update({ profileUrl: res.data.secure_url }); // yang disimpan tetap URL asli
  })
    .catch(err => {
      alert("Gagal upload ke Cloudinary.");
      console.error(err);
    });
});

    function getAtauBuatUserId() {
      let id = localStorage.getItem('userId');
      if (!id) {
        id = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', id);
      }
      return id;
    }

    function generateKodeUnik() {
      const huruf = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      let kode = "#";
      for (let i = 0; i < 7; i++) {
        kode += huruf.charAt(Math.floor(Math.random() * huruf.length));
      }
      return kode;
    }

    document.getElementById('namaInput').addEventListener('input', function () {
      const tentangInput = document.getElementById('tentangInput');
      if (!tentangInput.value) {
        tentangInput.value = generateKodeUnik();
      }
    });

    function simpanPengaturan() {
      const namaBaru = document.getElementById('namaInput').value.trim();
      const kodeUnik = document.getElementById('tentangInput').value.trim();
      const sekarang = Date.now();
      const batas30Hari = 30 * 24 * 60 * 60 * 1000;

      if (!namaBaru || !kodeUnik) {
        alert("Nama dan kode unik wajib diisi.");
        return;
      }

      userRef.once('value').then(snapshot => {
        const data = snapshot.val();
        const lastUpdate = data?.lastUpdate || 0;
        const bolehUpdate = sekarang - lastUpdate >= batas30Hari;

        if (!data || bolehUpdate) {
          userRef.update({
            nama: namaBaru,
            kode: kodeUnik,
            lastUpdate: sekarang
          }).then(() => {
            localStorage.setItem('nama', namaBaru);
            localStorage.setItem('kode', kodeUnik);
            alert("Data berhasil disimpan!");
            setTimeout(() => {
              window.location.href = "menu.html";
            }, 1500);
          });
        } else {
          const sisaHari = Math.ceil((batas30Hari - (sekarang - lastUpdate)) / (24 * 60 * 60 * 1000));
          alert("Nama hanya bisa diubah 1x per bulan.\nCoba lagi dalam " + sisaHari + " hari.");
          document.getElementById('namaInput').value = data.nama;
          document.getElementById('tentangInput').value = data.kode;
          setTimeout(() => {
            window.location.href = "menu.html";
          }, 1500);
        }
      }).catch(err => {
        console.error("Gagal simpan:", err);
        alert("Terjadi kesalahan saat menyimpan.");
      });
    }

    function muatPengaturan() {
      const namaInput = document.getElementById('namaInput');
      const tentangInput = document.getElementById('tentangInput');

      const nama = localStorage.getItem('nama');
      const kode = localStorage.getItem('kode');
      if (nama) namaInput.value = nama;
      if (kode) tentangInput.value = kode;

      userRef.once('value').then(snapshot => {
        const data = snapshot.val();
        if (data) {
          namaInput.value = data.nama || namaInput.value;
          tentangInput.value = data.kode || tentangInput.value;
          if (data.profileUrl) profilePic.src = data.profileUrl;
        }
      });
    }

    window.onload = muatPengaturan;
  </script>
  
  
  
  
  <script>
  document.getElementById('camera-icon').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('popup-menu').style.display = 'block';
  });

  function tutupPopup() {
    document.getElementById('popup-menu').style.display = 'none';
  }

  function ambilFoto() {
    alert('Fitur ambil foto belum tersedia.');
    tutupPopup();
  }

  function pilihDariGaleri() {
    document.getElementById('upload').click();
    tutupPopup();
  }

  function pakaiAvatar() {
    alert('Fitur ambil foto belum tersedia.');
    tutupPopup();
  }
</script>
  
</body>
</html>